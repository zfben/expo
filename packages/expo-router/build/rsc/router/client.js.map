{"version":3,"file":"client.js","sourceRoot":"","sources":["../../../src/rsc/router/client.ts"],"names":[],"mappings":"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","sourcesContent":["'use client';\n\nimport {\n  createContext,\n  createElement,\n  useCallback,\n  useContext,\n  useEffect,\n  useRef,\n  useState,\n  useTransition,\n  Fragment,\n} from 'react';\nimport type {\n  ComponentProps,\n  FunctionComponent,\n  ReactNode,\n  AnchorHTMLAttributes,\n  ReactElement,\n  MouseEvent,\n} from 'react';\n\nimport { prefetchRSC, Root, Slot, useRefetch } from '../client.js';\nimport { getComponentIds, getInputString, PARAM_KEY_SKIP, SHOULD_SKIP_ID } from './common.js';\nimport type { RouteProps, ShouldSkip } from './common.js';\n\ndeclare global {\n  interface ImportMeta {\n    readonly env: Record<string, string>;\n  }\n}\n\nconst parseLocation = (): RouteProps => {\n  if ((globalThis as any).__WAKU_ROUTER_404__) {\n    return { path: '/404', searchParams: new URLSearchParams() };\n  }\n  const { pathname, search } = window.location;\n  const searchParams = new URLSearchParams(search);\n  if (searchParams.has(PARAM_KEY_SKIP)) {\n    console.warn(`The search param \"${PARAM_KEY_SKIP}\" is reserved`);\n  }\n  return { path: pathname, searchParams };\n};\n\ntype ChangeLocation = (\n  path?: string,\n  searchParams?: URLSearchParams,\n  hash?: string,\n  method?: 'pushState' | 'replaceState' | false,\n  scrollTo?: ScrollToOptions | false\n) => void;\n\ntype PrefetchLocation = (path: string, searchParams: URLSearchParams) => void;\n\nconst RouterContext = createContext<{\n  loc: ReturnType<typeof parseLocation>;\n  changeLocation: ChangeLocation;\n  prefetchLocation: PrefetchLocation;\n} | null>(null);\n\nexport function useChangeLocation() {\n  const value = useContext(RouterContext);\n  if (!value) {\n    return () => {\n      throw new Error('Missing Router');\n    };\n  }\n  return value.changeLocation;\n}\n\nexport function useLocation() {\n  const value = useContext(RouterContext);\n  if (!value) {\n    throw new Error('Missing Router');\n  }\n  return value.loc;\n}\n\nexport type LinkProps = {\n  to: string;\n  pending?: ReactNode;\n  notPending?: ReactNode;\n  children: ReactNode;\n  unstable_prefetchOnEnter?: boolean;\n} & Omit<AnchorHTMLAttributes<HTMLAnchorElement>, 'href'>;\n\nexport function Link({\n  to,\n  children,\n  pending,\n  notPending,\n  unstable_prefetchOnEnter,\n  ...props\n}: LinkProps): ReactElement {\n  if (!to.startsWith('/')) {\n    throw new Error('Link must start with \"/\"');\n  }\n  const value = useContext(RouterContext);\n  const changeLocation = value\n    ? value.changeLocation\n    : () => {\n        throw new Error('Missing Router');\n      };\n  const prefetchLocation = value\n    ? value.prefetchLocation\n    : () => {\n        throw new Error('Missing Router');\n      };\n  const [isPending, startTransition] = useTransition();\n  const onClick = (event: MouseEvent<HTMLAnchorElement>) => {\n    event.preventDefault();\n    const url = new URL(to, window.location.href);\n    if (url.href !== window.location.href) {\n      prefetchLocation(url.pathname, url.searchParams);\n      startTransition(() => {\n        changeLocation(url.pathname, url.searchParams, url.hash);\n      });\n    }\n    props.onClick?.(event);\n  };\n  const onMouseEnter = unstable_prefetchOnEnter\n    ? (event: MouseEvent<HTMLAnchorElement>) => {\n        const url = new URL(to, window.location.href);\n        if (url.href !== window.location.href) {\n          prefetchLocation(url.pathname, url.searchParams);\n        }\n        props.onMouseEnter?.(event);\n      }\n    : props.onMouseEnter;\n  const ele = createElement('a', { ...props, href: to, onClick, onMouseEnter }, children);\n  if (isPending && pending !== undefined) {\n    return createElement(Fragment, null, ele, pending);\n  }\n  if (!isPending && notPending !== undefined) {\n    return createElement(Fragment, null, ele, notPending);\n  }\n  return ele;\n}\n\nconst getSkipList = (\n  componentIds: readonly string[],\n  props: RouteProps,\n  cached: Record<string, RouteProps>\n): string[] => {\n  const ele: any = document.querySelector('meta[name=\"waku-should-skip\"]');\n  if (!ele) {\n    return [];\n  }\n  const shouldSkip: ShouldSkip = JSON.parse(ele.content);\n  return componentIds.filter((id) => {\n    const prevProps = cached[id];\n    if (!prevProps) {\n      return false;\n    }\n    const shouldCheck = shouldSkip?.[id];\n    if (!shouldCheck) {\n      return false;\n    }\n    if (shouldCheck.path && props.path !== prevProps.path) {\n      return false;\n    }\n    if (\n      shouldCheck.keys?.some(\n        (key) => props.searchParams.get(key) !== prevProps.searchParams.get(key)\n      )\n    ) {\n      return false;\n    }\n    return true;\n  });\n};\n\nconst equalRouteProps = (a: RouteProps, b: RouteProps) => {\n  if (a.path !== b.path) {\n    return false;\n  }\n  if (a.searchParams.size !== b.searchParams.size) {\n    return false;\n  }\n  if (\n    Array.from(a.searchParams.entries()).some(([key, value]) => value !== b.searchParams.get(key))\n  ) {\n    return false;\n  }\n  return true;\n};\n\nfunction InnerRouter() {\n  const refetch = useRefetch();\n\n  const [loc, setLoc] = useState(parseLocation);\n  const componentIds = getComponentIds(loc.path);\n\n  const [cached, setCached] = useState<Record<string, RouteProps>>(() => {\n    return Object.fromEntries(componentIds.map((id) => [id, loc]));\n  });\n  const cachedRef = useRef(cached);\n  useEffect(() => {\n    cachedRef.current = cached;\n  }, [cached]);\n\n  const changeLocation: ChangeLocation = useCallback(\n    (path, searchParams, hash, method = 'pushState', scrollTo = { top: 0, left: 0 }) => {\n      const url = new URL(window.location.href);\n      if (typeof path === 'string') {\n        url.pathname = path;\n      }\n      if (searchParams) {\n        url.search = '?' + searchParams.toString();\n      }\n      if (typeof hash === 'string') {\n        url.hash = hash;\n      }\n      if (method) {\n        window.history[method](window.history.state, '', url);\n      }\n      const loc = parseLocation();\n      setLoc(loc);\n      if (scrollTo) {\n        window.scrollTo(scrollTo);\n      }\n      const componentIds = getComponentIds(loc.path);\n      if (\n        !method &&\n        componentIds.every((id) => {\n          const cachedLoc = cachedRef.current[id];\n          return cachedLoc && equalRouteProps(cachedLoc, loc);\n        })\n      ) {\n        return; // everything is cached\n      }\n      const skip = getSkipList(componentIds, loc, cachedRef.current);\n      if (componentIds.every((id) => skip.includes(id))) {\n        return; // everything is skipped\n      }\n      const input = getInputString(loc.path);\n      refetch(\n        input,\n        new URLSearchParams([\n          ...Array.from(loc.searchParams.entries()),\n          ...skip.map((id) => [PARAM_KEY_SKIP, id]),\n        ])\n      );\n      setCached((prev) => ({\n        ...prev,\n        ...Object.fromEntries(componentIds.flatMap((id) => (skip.includes(id) ? [] : [[id, loc]]))),\n      }));\n    },\n    [refetch]\n  );\n\n  const prefetchLocation: PrefetchLocation = useCallback((path, searchParams) => {\n    const componentIds = getComponentIds(path);\n    const routeProps: RouteProps = { path, searchParams };\n    const skip = getSkipList(componentIds, routeProps, cachedRef.current);\n    if (componentIds.every((id) => skip.includes(id))) {\n      return; // everything is cached\n    }\n    const input = getInputString(path);\n    const searchParamsString = new URLSearchParams([\n      ...Array.from(searchParams.entries()),\n      ...skip.map((id) => [PARAM_KEY_SKIP, id]),\n    ]).toString();\n    prefetchRSC(input, searchParamsString);\n    (globalThis as any).__WAKU_ROUTER_PREFETCH__?.(path);\n  }, []);\n\n  useEffect(() => {\n    const callback = () => {\n      const loc = parseLocation();\n      changeLocation(loc.path, loc.searchParams, '', false, false);\n    };\n    window.addEventListener('popstate', callback);\n    return () => window.removeEventListener('popstate', callback);\n  }, [changeLocation]);\n\n  const children = componentIds.reduceRight(\n    (acc: ReactNode, id) => createElement(Slot, { id, fallback: acc }, acc),\n    null\n  );\n\n  return createElement(\n    Fragment,\n    null,\n    createElement(Slot, { id: SHOULD_SKIP_ID }),\n    createElement(\n      RouterContext.Provider,\n      { value: { loc, changeLocation, prefetchLocation } },\n      children\n    )\n  );\n}\n\nexport function Router() {\n  const loc = parseLocation();\n  const initialInput = getInputString(loc.path);\n  const initialSearchParamsString = loc.searchParams.toString();\n  return createElement(\n    Root as FunctionComponent<Omit<ComponentProps<typeof Root>, 'children'>>,\n    { initialInput, initialSearchParamsString },\n    createElement(InnerRouter)\n  );\n}\n"]}