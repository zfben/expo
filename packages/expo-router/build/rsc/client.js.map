{"version":3,"file":"client.js","sourceRoot":"","sources":["../../src/rsc/client.tsx"],"names":[],"mappings":"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","sourcesContent":["// From Waku -- https://github.com/dai-shi/waku/blob/32d52242c1450b5f5965860e671ff73c42da8bd0/packages/waku/src/client.ts#L1\n\n/// <reference types=\"react/canary\" />\n'use client';\n\nimport * as FS from 'expo-file-system';\nimport {\n  createContext,\n  createElement,\n  memo,\n  use,\n  useCallback,\n  useState,\n  startTransition,\n} from 'react';\nimport type { ReactNode } from 'react';\nimport RSDWClient from 'react-server-dom-webpack/client';\n\nimport { encodeInput } from './renderers/utils';\nimport OS from '../../os';\nimport { getDevServer } from '../getDevServer';\n\nconst { createFromFetch, encodeReply } = RSDWClient;\n\ndeclare global {\n  interface ImportMeta {\n    readonly env: Record<string, string>;\n  }\n}\n\n// NOTE: Ensured to start with `/`.\nconst RSC_PATH = process.env.EXPO_RSC_PATH;\n\nlet BASE_PATH = `${process.env.EXPO_BASE_URL}${RSC_PATH}`;\n\nif (!BASE_PATH.startsWith('/')) {\n  BASE_PATH = '/' + BASE_PATH;\n}\n\nif (!BASE_PATH.endsWith('/')) {\n  BASE_PATH += '/';\n}\n\nif (BASE_PATH === '/') {\n  if (typeof process.env.EXPO_RSC_PATH !== 'string') {\n    throw new Error(\n      'process.env.EXPO_RSC_PATH was not defined. This is likely a misconfigured babel.config.js. Ensure babel-preset-expo is used.'\n    );\n  }\n  throw new Error(\n    `Invalid RSC path \"${BASE_PATH}\". The path should not live at the project root, e.g. /RSC/. Dev server URL: ${\n      getDevServer().fullBundleUrl\n    }`\n  );\n}\nconsole.log('[RSC]: Base path:', BASE_PATH, { BASE_URL: process.env.EXPO_BASE_URL, RSC_PATH });\n\nconst checkStatus = async (responsePromise: Promise<Response>): Promise<Response> => {\n  const response = await responsePromise;\n  if (!response.ok) {\n    // NOTE(EvanBacon): Transform the Metro development error into a JS error that can be used by LogBox.\n    // This was tested against using a Class component in a server component.\n    if (__DEV__ && response.status === 500) {\n      const errorJson = await response.json();\n      const err = new Error(errorJson.message);\n      for (const key in errorJson) {\n        (err as any)[key] = errorJson[key];\n      }\n      throw err;\n    }\n\n    const err = new Error(response.statusText);\n    (err as any).statusCode = response.status;\n    throw err;\n  }\n  console.log('[RSC]: Fetched', response.url, response.status);\n  return response;\n};\n\ntype Elements = Promise<Record<string, ReactNode>>;\n\nfunction getCached<T>(c: () => T, m: WeakMap<object, T>, k: object): T {\n  return (m.has(k) ? m : m.set(k, c())).get(k) as T;\n}\n\nconst cache1 = new WeakMap();\nconst mergeElements = (a: Elements, b: Elements | Awaited<Elements>): Elements => {\n  const getResult = async () => {\n    const nextElements = { ...(await a), ...(await b) };\n    delete nextElements._value;\n    return nextElements;\n  };\n  const cache2 = getCached(() => new WeakMap(), cache1, a);\n  return getCached(getResult, cache2, b);\n};\n\ntype SetElements = (fn: (prev: Elements) => Elements) => void;\ntype CacheEntry = [\n  input: string,\n  searchParamsString: string,\n  setElements: SetElements,\n  elements: Elements,\n];\n\nconst fetchCache: [CacheEntry?] = [];\n\nexport const fetchRSC = (\n  input: string,\n  searchParamsString: string,\n  setElements: SetElements,\n  cache = fetchCache\n): Elements => {\n  let entry: CacheEntry | undefined = cache[0];\n  if (entry && entry[0] === input && entry[1] === searchParamsString) {\n    entry[2] = setElements;\n    return entry[3];\n  }\n  const options = {\n    async callServer(actionId: string, args: unknown[]) {\n      const response = fetch(BASE_PATH + encodeInput(encodeURIComponent(actionId)), {\n        method: 'POST',\n        body: await encodeReply(args),\n        headers: {\n          'expo-platform': OS,\n        },\n      });\n      const data = createFromFetch<Awaited<Elements>>(checkStatus(response), options);\n      const setElements = entry![2];\n      startTransition(() => {\n        // FIXME this causes rerenders even if data is empty\n        setElements((prev) => mergeElements(prev, data));\n      });\n      return (await data)._value;\n    },\n  };\n  const prefetched = ((globalThis as any).__WAKU_PREFETCHED__ ||= {});\n  const url = BASE_PATH + encodeInput(input) + (searchParamsString ? '?' + searchParamsString : '');\n  console.log('fetch', url);\n  const response =\n    prefetched[url] ||\n    fetch(getAdjustedFilePath(url), {\n      headers: {\n        'expo-platform': OS,\n      },\n    });\n  delete prefetched[url];\n  const data = createFromFetch<Awaited<Elements>>(checkStatus(response), options);\n  cache[0] = entry = [input, searchParamsString, setElements, data];\n  return data;\n};\n\nfunction getAdjustedFilePath(path: string): string {\n  if (OS === 'web' || getDevServer().bundleLoadedFromServer) {\n    return path;\n  }\n  if (OS === 'android') {\n    return 'file:///android_asset' + path;\n  }\n\n  console.log('FS.bundleDirectory', FS.bundleDirectory);\n  return 'file://' + FS.bundleDirectory + path;\n}\n\nexport const prefetchRSC = (input: string, searchParamsString: string): void => {\n  const prefetched = ((globalThis as any).__WAKU_PREFETCHED__ ||= {});\n  const url = BASE_PATH + encodeInput(input) + (searchParamsString ? '?' + searchParamsString : '');\n  if (!(url in prefetched)) {\n    prefetched[url] = fetch(url, {\n      headers: {\n        'expo-platform': OS,\n      },\n    });\n  }\n};\n\nconst RefetchContext = createContext<(input: string, searchParams?: URLSearchParams) => void>(\n  () => {\n    throw new Error('Missing Root component');\n  }\n);\nconst ElementsContext = createContext<Elements | null>(null);\n\nexport const Root = ({\n  initialInput,\n  initialSearchParamsString,\n  cache,\n  children,\n}: {\n  initialInput?: string;\n  initialSearchParamsString?: string;\n  cache?: typeof fetchCache;\n  children: ReactNode;\n}) => {\n  const [elements, setElements] = useState(() =>\n    fetchRSC(initialInput || '', initialSearchParamsString || '', (fn) => setElements(fn), cache)\n  );\n  const refetch = useCallback(\n    (input: string, searchParams?: URLSearchParams) => {\n      const data = fetchRSC(input, searchParams?.toString() || '', setElements, cache);\n      setElements((prev) => mergeElements(prev, data));\n    },\n    [cache]\n  );\n  return createElement(\n    RefetchContext.Provider,\n    { value: refetch },\n    createElement(ElementsContext.Provider, { value: elements }, children)\n  );\n};\n\nexport const useRefetch = () => use(RefetchContext);\n\nconst ChildrenContext = createContext<ReactNode>(undefined);\nconst ChildrenContextProvider = memo(ChildrenContext.Provider);\n\nexport const Slot = ({\n  id,\n  children,\n  fallback,\n}: {\n  id: string;\n  children?: ReactNode;\n  fallback?: ReactNode;\n}) => {\n  const elementsPromise = use(ElementsContext);\n  if (!elementsPromise) {\n    throw new Error('Missing Root component');\n  }\n  const elements = use(elementsPromise);\n  if (!(id in elements)) {\n    if (fallback) {\n      return fallback;\n    }\n    throw new Error('Not found: ' + id);\n  }\n  return createElement(ChildrenContextProvider, { value: children }, elements[id]);\n};\n\nexport const Children = () => use(ChildrenContext);\n\nexport const ServerRoot = ({ elements, children }: { elements: Elements; children: ReactNode }) =>\n  createElement(ElementsContext.Provider, { value: elements }, children);\n"]}